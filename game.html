<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-Z æ¥µé€ŸæŒ‘æˆ° - éŠæˆ²ä¸­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        
        body {
            background: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        h1 {
            color: #0f0;
            font-size: 1.8rem;
        }
        
        .player-info {
            color: #888;
            font-size: 1rem;
        }
        
        #current-letter {
            font-size: 8rem;
            font-weight: bold;
            color: #0f0;
            margin: 30px 0;
            text-shadow: 0 0 20px #0f0;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #letter-sequence {
            font-size: 1.8rem;
            letter-spacing: 8px;
            margin: 20px 0;
            color: #555;
            min-height: 60px;
            line-height: 1.8;
        }
        
        .letter-correct {
            color: #0f0;
        }
        
        .letter-current {
            color: #fff;
            background: #222;
            padding: 0 5px;
        }
        
        .letter-future {
            color: #555;
        }
        
        #input-field {
            width: 100%;
            padding: 20px;
            font-size: 1.8rem;
            background: #111;
            color: #0f0;
            border: 3px solid #333;
            text-align: center;
            margin: 30px 0;
            outline: none;
            letter-spacing: 5px;
        }
        
        #input-field:focus {
            border-color: #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .stat {
            background: #111;
            padding: 20px;
            border: 1px solid #333;
        }
        
        .stat-value {
            font-size: 2.5rem;
            color: #0f0;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #888;
            margin-top: 8px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1rem;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            cursor: pointer;
        }
        
        button:hover {
            background: #444;
            border-color: #0f0;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #restart-btn {
            background: #333;
        }
        
        #back-btn {
            background: #555;
        }
        
        .game-status {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #111;
            color: #888;
        }
        
        .game-status.active {
            border-color: #0f0;
            color: #0f0;
        }
        
        .game-status.finished {
            border-color: #ff0;
            color: #ff0;
        }
        
        .leaderboard {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #333;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .leaderboard h3 {
            color: #0f0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        #leaderboard-list {
            list-style: none;
        }
        
        #leaderboard-list li {
            padding: 12px;
            background: #111;
            margin-bottom: 8px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .rank {
            color: #ff0;
            font-weight: bold;
            min-width: 40px;
        }
        
        .player {
            flex-grow: 1;
            text-align: left;
            margin-left: 15px;
        }
        
        .time {
            color: #0f0;
            font-weight: bold;
            min-width: 100px;
            text-align: right;
        }
        
        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            background: #111;
            border: 1px solid #333;
            color: #0f0;
            font-size: 0.8rem;
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            #current-letter {
                font-size: 5rem;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">API: é€£ç·šä¸­...</div>
    
    <div class="container">
        <div class="header">
            <h1>A-Z æ¥µé€Ÿæ‰“å­—æŒ‘æˆ°</h1>
            <div class="player-info">ç©å®¶: <span id="playerName">è¼‰å…¥ä¸­...</span></div>
        </div>
        
        <div id="current-letter">A</div>
        
        <div id="letter-sequence">
            <span class="letter-correct"></span>
            <span class="letter-current">A</span>
            <span class="letter-future">B C D E F G H I J K L M N O P Q R S T U V W X Y Z</span>
        </div>
        
        <input type="text" id="input-field" placeholder="è¼¸å…¥ä¸Šæ–¹é¡¯ç¤ºçš„å­—æ¯..." autocomplete="off" autofocus>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="timer">0.000</div>
                <div class="stat-label">ç”¨æ™‚ (ç§’)</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="progress">0%</div>
                <div class="stat-label">å®Œæˆé€²åº¦</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accuracy">100%</div>
                <div class="stat-label">æº–ç¢ºåº¦</div>
            </div>
        </div>
        
        <div class="game-status" id="gameStatus">
            ç­‰å¾…é–‹å§‹ï¼šè«‹è¼¸å…¥ç¬¬ä¸€å€‹å­—æ¯ "A"
        </div>
        
        <div class="controls">
            <button id="restart-btn">é‡æ–°æŒ‘æˆ°</button>
            <button id="back-btn">è¿”å›ç™»å…¥</button>
        </div>
        
        <div class="leaderboard">
            <h3>ğŸ† æ’è¡Œæ¦œ (æœ€å¿«å®Œæˆæ™‚é–“)</h3>
            <ul id="leaderboard-list">
                <li>è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
    </div>

    <script>
        // ==================== é…ç½®å€åŸŸ ====================
        // API è¨­å®š - å·²ç¶“ç‚ºä½ è¨­å®šå¥½
        const API_CONFIG = {
            BASE_URL: 'https://keyboard-challenge-api.onrender.com',
            ENABLED: true, // è¨­ç‚º false å‰‡ä½¿ç”¨ç´”æœ¬åœ°æ¨¡å¼
            TIMEOUT: 5000
        };
        
        // éŠæˆ²è¨­å®š
        const GAME_CONFIG = {
            LETTERS: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
            AUTO_START: true, // è¼¸å…¥ç¬¬ä¸€å€‹å­—æ¯è‡ªå‹•é–‹å§‹è¨ˆæ™‚
            AUTO_SUBMIT: true // å®Œæˆå¾Œè‡ªå‹•æäº¤æˆç¸¾
        };
        
        // ==================== éŠæˆ²ç‹€æ…‹ ====================
        let gameState = {
            active: false,
            startTime: null,
            endTime: null,
            currentIndex: 0,
            correctInputs: 0,
            totalInputs: 0,
            username: '',
            letters: GAME_CONFIG.LETTERS.split(''),
            timerInterval: null
        };
        
        // ==================== DOM å…ƒç´  ====================
        const elements = {
            currentLetter: document.getElementById('current-letter'),
            letterSequence: document.getElementById('letter-sequence'),
            inputField: document.getElementById('input-field'),
            timer: document.getElementById('timer'),
            progress: document.getElementById('progress'),
            accuracy: document.getElementById('accuracy'),
            gameStatus: document.getElementById('gameStatus'),
            playerName: document.getElementById('playerName'),
            restartBtn: document.getElementById('restart-btn'),
            backBtn: document.getElementById('back-btn'),
            apiStatus: document.getElementById('apiStatus'),
            leaderboardList: document.getElementById('leaderboard-list')
        };
        
        // ==================== åˆå§‹åŒ– ====================
        async function initGame() {
            // 1. ç²å–ç©å®¶åç¨±
            gameState.username = localStorage.getItem('typingUsername');
            if (!gameState.username) {
                alert('è«‹å…ˆç™»å…¥ï¼');
                window.location.href = 'index.html';
                return;
            }
            elements.playerName.textContent = gameState.username;
            
            // 2. æª¢æŸ¥APIç‹€æ…‹
            await checkApiStatus();
            
            // 3. è¼‰å…¥æ’è¡Œæ¦œ
            await loadLeaderboard();
            
            // 4. åˆå§‹åŒ–éŠæˆ²é¡¯ç¤º
            updateLetterDisplay();
            elements.inputField.focus();
            
            // 5. ç¶å®šäº‹ä»¶
            bindEvents();
        }
        
        // ==================== API åŠŸèƒ½ ====================
        async function checkApiStatus() {
            if (!API_CONFIG.ENABLED) {
                elements.apiStatus.textContent = 'API: é›¢ç·šæ¨¡å¼';
                elements.apiStatus.style.color = '#888';
                return false;
            }
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.TIMEOUT);
                
                const response = await fetch(`${API_CONFIG.BASE_URL}/`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    elements.apiStatus.textContent = 'API: é€£ç·šæ­£å¸¸ âœ“';
                    elements.apiStatus.style.color = '#0f0';
                    return true;
                }
            } catch (error) {
                console.warn('APIé€£æ¥å¤±æ•—ï¼Œåˆ‡æ›åˆ°æœ¬åœ°æ¨¡å¼:', error);
                elements.apiStatus.textContent = 'API: é›¢ç·šæ¨¡å¼';
                elements.apiStatus.style.color = '#f00';
                API_CONFIG.ENABLED = false;
            }
            return false;
        }
        
        async function submitScore(timeInSeconds) {
            if (!API_CONFIG.ENABLED) {
                saveScoreLocally(timeInSeconds);
                return { success: false, local: true };
            }
            
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/api/score`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: gameState.username,
                        time: timeInSeconds,
                        accuracy: calculateAccuracy(),
                        date: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    return { success: true };
                }
            } catch (error) {
                console.warn('æäº¤åˆ†æ•¸å¤±æ•—ï¼Œä¿å­˜åˆ°æœ¬åœ°:', error);
                saveScoreLocally(timeInSeconds);
                return { success: false, local: true };
            }
            
            return { success: false };
        }
        
        async function loadLeaderboard() {
            // å…ˆå˜—è©¦å¾APIè¼‰å…¥
            if (API_CONFIG.ENABLED) {
                try {
                    const response = await fetch(`${API_CONFIG.BASE_URL}/api/leaderboard`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.leaderboard && data.leaderboard.length > 0) {
                            displayLeaderboard(data.leaderboard);
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('è¼‰å…¥APIæ’è¡Œæ¦œå¤±æ•—:', error);
                }
            }
            
            // è¼‰å…¥æœ¬åœ°æ’è¡Œæ¦œ
            loadLocalLeaderboard();
        }
        
        function saveScoreLocally(timeInSeconds) {
            const scores = JSON.parse(localStorage.getItem('localTypingScores') || '[]');
            scores.push({
                name: gameState.username,
                time: timeInSeconds,
                accuracy: calculateAccuracy(),
                date: new Date().toISOString()
            });
            
            // åªä¿ç•™æœ€å¥½çš„50å€‹æˆç¸¾
            scores.sort((a, b) => a.time - b.time);
            const topScores = scores.slice(0, 50);
            localStorage.setItem('localTypingScores', JSON.stringify(topScores));
            
            // æ›´æ–°é¡¯ç¤º
            displayLeaderboard(topScores);
        }
        
        function loadLocalLeaderboard() {
            const scores = JSON.parse(localStorage.getItem('localTypingScores') || '[]');
            displayLeaderboard(scores);
        }
        
        function displayLeaderboard(scores) {
            if (!scores || scores.length === 0) {
                elements.leaderboardList.innerHTML = '<li>æš«ç„¡ç´€éŒ„ï¼Œæˆç‚ºç¬¬ä¸€å€‹æŒ‘æˆ°è€…ï¼</li>';
                return;
            }
            
            // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€å¿«åˆ°æœ€æ…¢ï¼‰
            scores.sort((a, b) => a.time - b.time);
            
            elements.leaderboardList.innerHTML = '';
            scores.slice(0, 20).forEach((score, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="rank">#${index + 1}</span>
                    <span class="player">${score.name}</span>
                    <span class="time">${score.time.toFixed(3)}ç§’</span>
                `;
                elements.leaderboardList.appendChild(li);
            });
        }
        
        // ==================== éŠæˆ²é‚è¼¯ ====================
        function startGame() {
            if (gameState.active) return;
            
            gameState.active = true;
            gameState.startTime = performance.now();
            gameState.endTime = null;
            
            elements.gameStatus.textContent = 'æŒ‘æˆ°é€²è¡Œä¸­...';
            elements.gameStatus.className = 'game-status active';
            
            // é–‹å§‹è¨ˆæ™‚å™¨
            gameState.timerInterval = setInterval(updateTimer, 10);
            
            // æ›´æ–°é¡¯ç¤º
            updateLetterDisplay();
        }
        
        function endGame() {
            if (!gameState.active) return;
            
            gameState.active = false;
            gameState.endTime = performance.now();
            
            clearInterval(gameState.timerInterval);
            
            // è¨ˆç®—ç¸½ç”¨æ™‚
            const totalTime = (gameState.endTime - gameState.startTime) / 1000;
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            elements.gameStatus.textContent = `æŒ‘æˆ°å®Œæˆï¼ç”¨æ™‚: ${totalTime.toFixed(3)}ç§’`;
            elements.gameStatus.className = 'game-status finished';
            
            // ç¦ç”¨è¼¸å…¥æ¡†
            elements.inputField.disabled = true;
            
            // è‡ªå‹•æäº¤æˆç¸¾
            if (GAME_CONFIG.AUTO_SUBMIT) {
                submitScore(totalTime).then(result => {
                    if (result.success) {
                        elements.gameStatus.textContent += ' (æˆç¸¾å·²æäº¤)';
                    } else if (result.local) {
                        elements.gameStatus.textContent += ' (æˆç¸¾ä¿å­˜åˆ°æœ¬åœ°)';
                    }
                    // é‡æ–°è¼‰å…¥æ’è¡Œæ¦œ
                    loadLeaderboard();
                });
            }
        }
        
        function resetGame() {
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState.active = false;
            gameState.startTime = null;
            gameState.endTime = null;
            gameState.currentIndex = 0;
            gameState.correctInputs = 0;
            gameState.totalInputs = 0;
            
            // æ¸…é™¤è¨ˆæ™‚å™¨
            clearInterval(gameState.timerInterval);
            
            // é‡ç½®é¡¯ç¤º
            elements.timer.textContent = '0.000';
            elements.progress.textContent = '0%';
            elements.accuracy.textContent = '100%';
            elements.inputField.value = '';
            elements.inputField.disabled = false;
            elements.gameStatus.textContent = 'ç­‰å¾…é–‹å§‹ï¼šè«‹è¼¸å…¥ç¬¬ä¸€å€‹å­—æ¯ "A"';
            elements.gameStatus.className = 'game-status';
            
            // æ›´æ–°å­—æ¯é¡¯ç¤º
            updateLetterDisplay();
            
            // èšç„¦è¼¸å…¥æ¡†
            elements.inputField.focus();
        }
        
        function updateTimer() {
            if (!gameState.active || !gameState.startTime) return;
            
            const currentTime = performance.now();
            const elapsed = (currentTime - gameState.startTime) / 1000;
            elements.timer.textContent = elapsed.toFixed(3);
        }
        
        function updateLetterDisplay() {
            const currentLetter = gameState.letters[gameState.currentIndex];
            
            // æ›´æ–°ç•¶å‰å­—æ¯
            elements.currentLetter.textContent = currentLetter;
            
            // æ›´æ–°å­—æ¯åºåˆ—
            const correctLetters = gameState.letters.slice(0, gameState.currentIndex);
            const futureLetters = gameState.letters.slice(gameState.currentIndex + 1);
            
            elements.letterSequence.innerHTML = `
                <span class="letter-correct">${correctLetters.join(' ')}${correctLetters.length > 0 ? ' ' : ''}</span>
                <span class="letter-current">${currentLetter}</span>
                <span class="letter-future">${futureLetters.length > 0 ? ' ' + futureLetters.join(' ') : ''}</span>
            `;
            
            // æ›´æ–°é€²åº¦
            const progress = Math.round((gameState.currentIndex / gameState.letters.length) * 100);
            elements.progress.textContent = `${progress}%`;
        }
        
        function calculateAccuracy() {
            return gameState.totalInputs > 0 ? 
                Math.round((gameState.correctInputs / gameState.totalInputs) * 100) : 100;
        }
        
        function handleInput(event) {
            const input = event.target.value.toUpperCase();
            
            if (!input) return;
            
            const expectedLetter = gameState.letters[gameState.currentIndex];
            gameState.totalInputs++;
            
            // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º
            if (input === expectedLetter) {
                gameState.correctInputs++;
                
                // å¦‚æœæ˜¯ç¬¬ä¸€å€‹å­—æ¯ä¸”éŠæˆ²å°šæœªé–‹å§‹ï¼Œå‰‡é–‹å§‹éŠæˆ²
                if (gameState.currentIndex === 0 && !gameState.active && GAME_CONFIG.AUTO_START) {
                    startGame();
                }
                
                // ç§»å‹•åˆ°ä¸‹ä¸€å€‹å­—æ¯
                gameState.currentIndex++;
                
                // æª¢æŸ¥æ˜¯å¦å®Œæˆ
                if (gameState.currentIndex >= gameState.letters.length) {
                    endGame();
                } else {
                    updateLetterDisplay();
                }
                
                // æ¸…ç©ºè¼¸å…¥æ¡†
                event.target.value = '';
                
                // æ›´æ–°æº–ç¢ºåº¦
                elements.accuracy.textContent = `${calculateAccuracy()}%`;
            } else {
                // è¼¸å…¥éŒ¯èª¤ï¼Œåªæ¸…ç©ºè¼¸å…¥æ¡†
                event.target.value = '';
                elements.accuracy.textContent = `${calculateAccuracy()}%`;
            }
        }
        
        // ==================== äº‹ä»¶ç¶å®š ====================
        function bindEvents() {
            // è¼¸å…¥æ¡†äº‹ä»¶
            elements.inputField.addEventListener('input', handleInput);
            
            // é‡æ–°æŒ‘æˆ°æŒ‰éˆ•
            elements.restartBtn.addEventListener('click', resetGame);
            
            // è¿”å›ç™»å…¥æŒ‰éˆ•
            elements.backBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // éµç›¤å¿«æ·éµ
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    resetGame();
                }
                
                if (event.key === 'Enter' && !gameState.active) {
                    resetGame();
                }
                
                // ç¢ºä¿è¼¸å…¥æ¡†æ°¸é æœ‰ç„¦é»ï¼ˆé™¤éåœ¨è¼¸å…¥ï¼‰
                if (document.activeElement !== elements.inputField && 
                    !event.ctrlKey && !event.altKey && !event.metaKey) {
                    elements.inputField.focus();
                }
            });
        }
        
        // ==================== å•Ÿå‹•éŠæˆ² ====================
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>